# 채팅방 입장 문제 해결 회고

## 문제 상황
- **증상**: 닉네임을 입력하고 채팅방 입장 시 "입장에 실패했습니다" 알림 발생
- **환경**: Phoenix 1.8 + Ash Framework 3.5.38 + AshSqlite + LiveView
- **기간**: 여러 세션에 걸쳐 발생한 지속적인 문제

## 문제 분석 과정

### 1차 시도들 (실패)
- `require Ash.Query` 추가로 컴파일 에러 해결
- Room 로딩 방식 수정 (`Ash.get` 사용)
- Domain 파라미터 추가
- 다양한 changeset 생성 방식 시도

### 핵심 문제 발견
로그 분석을 통해 발견한 실제 에러:
```
%Ash.Error.Changes.Required{
  field: :room_id,
  type: :argument,
  resource: About.Chat.Participant,
  class: :invalid
}
```

## 근본 원인

### ❌ 문제가 있던 접근법
```elixir
# participant.ex - 복잡한 argument 처리
create :join_room do
  accept [:nickname]
  
  argument :room_id, :uuid do
    allow_nil? false
  end
  
  argument :user_id, :uuid do
    allow_nil? true
  end
  
  change fn changeset, _context ->
    room_id = Ash.Changeset.get_argument(changeset, :room_id)
    user_id = Ash.Changeset.get_argument(changeset, :user_id)
    
    changeset
    |> Ash.Changeset.change_attribute(:room_id, room_id)
    |> Ash.Changeset.change_attribute(:user_id, user_id)
  end
end

# room.ex - 복잡한 arguments 옵션
changeset = Ash.Changeset.for_create(About.Chat.Participant, :join_room, %{
  nickname: nickname
}, arguments: %{
  room_id: room_id,
  user_id: user_id
})
```

### ✅ 해결책
```elixir
# participant.ex - 단순한 accept 사용
create :join_room do
  accept [:nickname, :room_id, :user_id]
end

# room.ex - 직접 attributes 전달
changeset = Ash.Changeset.for_create(About.Chat.Participant, :join_room, %{
  nickname: nickname,
  room_id: room_id,
  user_id: user_id
})
```

## 해결 과정

### Context7을 통한 공식 문서 확인
- Ash Framework의 올바른 사용법 학습
- `manage_relationship` vs 직접 attributes 사용법 비교
- 공식 패턴과 베스트 프랙티스 확인

### 핵심 변경사항
1. **복잡한 argument/change 로직 제거**
2. **단순한 accept 패턴 적용**
3. **컴파일 캐시 정리** (`mix clean`)
4. **Unused alias 경고 정리**

## 교훈 및 인사이트

### 1. KISS 원칙의 중요성
- 복잡한 argument → attributes 변환 로직보다는 직접 accept하는 것이 더 안정적
- Ash Framework에서는 **단순함이 최고의 해결책**

### 2. 프레임워크 이해의 중요성
- Ash Framework의 철학과 패턴을 제대로 이해하지 못한 상태에서 임의로 구현
- 공식 문서와 베스트 프랙티스를 먼저 확인하는 것의 중요성

### 3. 컴파일 캐시 문제
- 코드 변경 후에도 이전 버전이 캐시되어 동일한 에러 발생
- `mix clean` 후 재컴파일의 중요성

### 4. 체계적인 디버깅
- 로그 분석을 통한 정확한 문제 파악
- 에러 메시지의 `type: :argument` 힌트가 핵심이었음

## 성과

### 기술적 성과
- ✅ 채팅방 입장 기능 정상 작동
- ✅ 깔끔한 코드 구조 (unused alias 정리)
- ✅ 컴파일 경고 없는 깨끗한 빌드

### 학습 성과
- Ash Framework의 올바른 사용법 습득
- Phoenix LiveView + Ash 통합 패턴 이해
- Elixir 생태계에서의 디버깅 방법론 향상

## 향후 개선 방향

### 개발 프로세스
1. **프레임워크 공식 문서 우선 참조**
2. **단순한 구현부터 시작** (점진적 복잡성 추가)
3. **컴파일 캐시 정리 루틴화**
4. **로그 기반 체계적 디버깅**

### 코드 품질
- 불필요한 복잡성 제거
- 프레임워크 관례 준수
- 명확한 에러 핸들링

## 결론

이번 문제 해결을 통해 **"프레임워크를 이해하고 단순하게 접근하는 것"**의 중요성을 깨달았습니다. 

특히 Ash Framework 같은 강력한 도구를 사용할 때는:
1. 공식 패턴을 먼저 이해하고
2. 가장 단순한 방법부터 시도하며  
3. 복잡한 로직은 정말 필요할 때만 추가하는 것

이 핵심이라는 점을 배웠습니다.

---
**작성일**: 2025-09-06  
**해결 시간**: 약 3시간 (여러 세션)  
**핵심 키워드**: Ash Framework, Phoenix LiveView, arguments vs attributes, KISS 원칙